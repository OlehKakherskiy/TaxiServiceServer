<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:repository="http://www.springframework.org/schema/data/repository"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xsi:schemaLocation="http://www.springframework.org/schema/beans  http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context   http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/data/jpa  http://www.springframework.org/schema/data/jpa/spring-jpa.xsd">

    <beans profile="inMem">
        <context:component-scan base-package="ua.kpi.mobiledev.repository.inmem"/>
        <bean id="resetPasswordRepository" class="ua.kpi.mobiledev.repository.ResetPasswordRepositoryImpl">
            <property name="redisTemplate" ref="redisTemplate"/>
            <property name="expireDurationInMs" value="${security.resetPasswordCodeAlive}"/>
        </bean>
    </beans>

    <beans profile="prod;local">
        <jpa:repositories base-package="ua.kpi.mobiledev.repository" entity-manager-factory-ref="entityManagerFactory"
                          enable-default-transactions="false">
            <repository:exclude-filter type="regex" expression="ua\.kpi\.mobiledev\.repository\.inmem\.*"/>
        </jpa:repositories>
        <jpa:repositories base-package="ua.kpi.mobiledev.repository" repository-impl-postfix="Impl"/>

        <context:component-scan base-package="ua.kpi.mobiledev.repository"/>

        <bean id="securityDetailsRepository" class="ua.kpi.mobiledev.web.security.service.SecurityDetailsRepositoryImpl"/>

        <bean name="entityManagerFactory"
              class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
            <property name="dataSource" ref="dataSource"/>
            <property name="jpaVendorAdapter">
                <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"/>
            </property>
            <property name="persistenceProviderClass" value="org.hibernate.jpa.HibernatePersistenceProvider"/>
            <property name="packagesToScan">
                <list>
                    <value>ua.kpi.mobiledev.domain</value>
                    <value>ua.kpi.mobiledev.web.security.model</value>
                </list>
            </property>
            <property name="jpaProperties">
                <props>
                    <prop key="hibernate.dialect">org.hibernate.dialect.MySQLDialect</prop>
                    <prop key="hibernate.show_sql">true</prop>
                    <prop key="hibernate.format_sql">true</prop>
                    <prop key="hibernate.validator.fail_fast">false</prop>
                </props>
            </property>
        </bean>
    </beans>

    <beans profile="prod">

        <context:property-placeholder system-properties-mode="OVERRIDE" location="WEB-INF/jdbc.properties"
                                      ignore-unresolvable="true"/>
        <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
            <property name="driverClass" value="${driver}"/>
            <property name="jdbcUrl" value="jdbc:mysql://us-cdbr-iron-east-04.cleardb.net/heroku_c6f857e7f6daba9?cachePrepStmts=true&amp;useServerPrepStmts=true&amp;useUnicode=yes&amp;characterEncoding=UTF-8"/>
            <property name="user" value="${user}"/>
            <property name="password" value="${password}"/>
            <property name="initialPoolSize" value="${initialPoolSize}"/>
            <property name="maxPoolSize" value="${maxPoolSize}"/>
            <property name="loginTimeout" value="${loginTimeout}"/>
        </bean>
    </beans>

    <beans profile="local">
        <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
            <property name="driverClass" value="com.mysql.jdbc.Driver"/>
            <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/taxiservice?connectTimeout=10000&amp;cachePrepStmts=true&amp;useServerPrepStmts=true&amp;useUnicode=yes&amp;characterEncoding=UTF-8"/>
            <property name="user" value="root"/>
            <property name="password" value="root"/>
            <property name="initialPoolSize" value="1"/>
            <property name="maxPoolSize" value="1"/>
            <property name="loginTimeout" value="5"/>
        </bean>
    </beans>

    <beans xmlns:jdbc="http://www.springframework.org/schema/jdbc"
           xsi:schemaLocation="http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc.xsd"
           profile="test">
        <jdbc:embedded-database id="dataSource" type="HSQL">
            <jdbc:script location="db_dump/local_schema_generation.sql"/>
        </jdbc:embedded-database>
    </beans>
</beans>